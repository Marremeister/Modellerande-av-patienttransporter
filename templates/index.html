<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Transport Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        select, button {
            padding: 10px;
            font-size: 16px;
        }
        .node {
            fill: lightblue;
            stroke: #333;
            stroke-width: 2px;
        }
        .link {
            stroke: #777;
            stroke-width: 2px;
        }
        .transporter {
            fill: red;
            stroke: black;
            stroke-width: 2px;
        }
        text {
            font-size: 14px;
            fill: black;
            font-weight: bold;
        }
        svg {
            width: 90vw;
            height: 90vh;
            background-color: #f4f4f4;
            display: block;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Hospital Transport System</h1>
    <div class="controls">
        <label for="transporterSelect">Choose a Transporter:</label>
        <select id="transporterSelect"></select>

        <label for="requestSelect">Choose a Transport Request:</label>
        <select id="requestSelect"></select>

        <button onclick="initiateTransport()">Initiate Patient Transport</button>
        <button id="returnHomeBtn" onclick="returnHome()">Return Home</button>

    </div>
    <div class="request-form">
    <h3>Create New Transport Request</h3>

    <label for="originDropdown">Origin:</label>
    <select id="originDropdown"></select>

    <label for="destinationDropdown">Destination:</label>
    <select id="destinationDropdown"></select>

    <label for="typeDropdown">Transport Type:</label>
    <select id="typeDropdown">
        <option value="stretcher">Stretcher</option>
        <option value="wheelchair">Wheelchair</option>
    </select>

    <label for="urgentDropdown">Urgency:</label>
    <select id="urgentDropdown">
        <option value="true">Urgent</option>
        <option value="false">Not Urgent</option>
    </select>

    <button onclick="createRequest()">Create Request</button>
</div>

    <svg viewBox="-100 -100 1400 1000"></svg>

    <script>
        var svg = d3.select("svg"), width = 1400, height = 1000;
        var transporters = {}, transportRequests = {}, transporterNodes = {};
        var socket = io("http://127.0.0.1:5001");

        function loadHospitalGraph() {
    fetch("http://127.0.0.1:5001/get_hospital_graph")
        .then(response => response.json())
        .then(graph => {
            let nodesMap = new Map(graph.nodes.map(n => [n.id, { id: n.id, x: n.x, y: n.y }]));

            let edges = graph.edges.map(e => ({
                source: nodesMap.get(e.source),
                target: nodesMap.get(e.target),
                weight: e.distance  // 🔹 Store weight for display
            }));

            // Draw edges (lines)
            svg.append("g").selectAll("line").data(edges).enter().append("line")
                .attr("class", "link")
                .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x).attr("y2", d => d.target.y);

            // Draw edge weights (text)
            svg.append("g").selectAll("text.edge-label").data(edges).enter().append("text")
                .attr("class", "edge-label")
                .attr("x", d => (d.source.x + d.target.x) / 2)  // 🔹 Middle of the edge
                .attr("y", d => (d.source.y + d.target.y) / 2 - 5)  // 🔹 Slightly above
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .attr("font-size", "12px")
                .attr("font-weight", "bold")
                .text(d => d.weight);  // 🔹 Display weight

            // Draw nodes (circles)
            svg.append("g").selectAll("circle").data([...nodesMap.values()]).enter().append("circle")
                .attr("class", "node").attr("r", 20)
                .attr("cx", d => d.x).attr("cy", d => d.y)
                .attr("data-node", d => d.id);

            // Draw node labels (text)
            svg.append("g").selectAll("text").data([...nodesMap.values()]).enter().append("text")
                .attr("x", d => d.x + 10).attr("y", d => d.y - 10).text(d => d.id);
        });
}

        function returnHome() {
    const selectedTransporter = document.getElementById("transporterSelect").value;

    if (!selectedTransporter) {
        alert("Please select a transporter first.");
        return;
    }

    fetch("/return_home", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ transporter: selectedTransporter })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            alert(data.status);
        }
    })
    .catch(error => console.error("Error:", error));
}

        function loadTransporters() {
            fetch("http://127.0.0.1:5001/get_transporters")
                .then(response => response.json())
                .then(data => {
                    let select = document.getElementById("transporterSelect");
                    select.innerHTML = "";
                    data.forEach(trans => {
                        let option = document.createElement("option");
                        option.value = trans.name;
                        option.textContent = trans.name;
                        select.appendChild(option);
                        transporters[trans.name] = trans.current_location;

                        createTransporterVisual(trans.name, trans.current_location);
                    });
                });
        }
        function loadDepartmentDropdowns() {
    fetch("http://127.0.0.1:5001/get_hospital_graph")
        .then(response => response.json())
        .then(graph => {
            console.log("🏥 Loaded hospital graph:", graph); // 🔹 Debugging

            let originDropdown = document.getElementById("originDropdown");
            let destinationDropdown = document.getElementById("destinationDropdown");

            originDropdown.innerHTML = "";
            destinationDropdown.innerHTML = "";

            if (!graph.nodes || graph.nodes.length === 0) {
                console.error("❌ No nodes found in hospital graph!");
                return;
            }

            graph.nodes.forEach(node => {
                let option1 = document.createElement("option");
                option1.value = node.id;
                option1.textContent = node.id;
                originDropdown.appendChild(option1);

                let option2 = document.createElement("option");
                option2.value = node.id;
                option2.textContent = node.id;
                destinationDropdown.appendChild(option2);
            });

            console.log("✅ Dropdowns populated successfully!");
        })
        .catch(error => console.error("❌ Error fetching departments:", error));
}


        function createRequest() {
    let origin = document.getElementById("originDropdown").value;
    let destination = document.getElementById("destinationDropdown").value;
    let transportType = document.getElementById("typeDropdown").value;
    let urgent = document.getElementById("urgentDropdown").value === "true";

    if (!origin || !destination || origin === destination) {
        alert("Please select a valid origin and destination.");
        return;
    }

    fetch("http://127.0.0.1:5001/frontend_transport_request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ origin, destination, transport_type: transportType, urgent })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.status || "Request created successfully!");
        loadTransportRequests();  // 🔹 Refresh the request list
    })
    .catch(error => console.error("❌ Error:", error));
}


function removeRequest(requestKey) {
    fetch("http://127.0.0.1:5001/remove_transport_request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ requestKey })
    })
    .then(response => response.json())
    .then(data => {
        console.log("✅ Request removed:", data);
        loadTransportRequests();  // 🔹 Refresh dropdown after removal
    })
    .catch(error => console.error("❌ Error:", error));
}

socket.on("transport_complete", function (data) {
    console.log("🚀 Transport completed:", data);
    removeRequest(data.requestKey);
});


        function loadTransportRequests() {
            fetch("http://127.0.0.1:5001/get_transport_requests")
                .then(response => response.json())
                .then(data => {
                    let select = document.getElementById("requestSelect");
                    select.innerHTML = "";
                    data.forEach(req => {
                        let option = document.createElement("option");
                        option.value = `${req.origin}-${req.destination}`;
                        option.textContent = `${req.transport_type} from ${req.origin} to ${req.destination}`;
                        select.appendChild(option);
                        transportRequests[option.value] = req;
                    });
                });
        }

        function createTransporterVisual(name, location) {
            let nodeElement = document.querySelector(`[data-node='${location}']`);

            if (!nodeElement) {
                console.error(`❌ Error: Node '${location}' not found for transporter '${name}'.`);
                return;
            }

            let x = parseFloat(nodeElement.getAttribute("cx"));
            let y = parseFloat(nodeElement.getAttribute("cy"));

            console.log(`🚛 Creating transporter ${name} at (${x}, ${y})`);

            transporterNodes[name] = svg.append("circle")
                .attr("class", "transporter")
                .attr("r", 10)
                .attr("cx", x)
                .attr("cy", y)
                .attr("fill", "red")
                .attr("data-transporter", name);
        }

        function updateTransporterVisual(name, newLocation) {
            let nodeElement = document.querySelector(`[data-node='${newLocation}']`);
            let transporterElement = d3.select(`[data-transporter='${name}']`);

            if (!nodeElement || transporterElement.empty()) {
                console.error(`❌ Error: Node '${newLocation}' or transporter '${name}' not found for movement.`);
                return;
            }

            let x = parseFloat(nodeElement.getAttribute("cx"));
            let y = parseFloat(nodeElement.getAttribute("cy"));

            console.log(`📍 Moving transporter ${name} to ${newLocation} at (${x}, ${y})`);

            transporterElement
                .transition()
                .duration(1000)
                .attr("cx", x)
                .attr("cy", y)
                .on("end", () => console.log(`✅ ${name} arrived at (${x}, ${y})`));
        }

        socket.on("transporter_update", function (data) {
            console.log("🚀 Transporter update received:", data);
            let transporterName = data.name;
            let newLocation = data.location;

            if (!transporterNodes[transporterName]) {
                console.error("⚠️ Transporter element not found in visualization for", transporterName);
                return;
            }

            updateTransporterVisual(transporterName, newLocation);
        });

        function initiateTransport() {
            let transporterName = document.getElementById("transporterSelect").value;
            let requestValue = document.getElementById("requestSelect").value;
            let requestObj = transportRequests[requestValue];

            if (!transporterName || !requestObj) {
                console.error("⚠️ Missing transporter or transport request selection.");
                return;
            }

            fetch("http://127.0.0.1:5001/assign_transport", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    transporter: transporterName,
                    origin: requestObj.origin,
                    destination: requestObj.destination,
                    transport_type: requestObj.transport_type,
                    urgent: requestObj.urgent
                })
            })
            .then(response => response.json())
            .then(data => console.log("✅ Response:", data))
            .catch(error => console.error("❌ Error:", error));
        }

        window.onload = function () {
            loadHospitalGraph();
            loadTransporters();
            loadTransportRequests();
            loadDepartmentDropdowns();
        };
    </script>
</body>
</html>
