<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Transport Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* Natural Color Theme */
        body {
            font-family: 'Arial', sans-serif;
            background: #f7f9fc;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Title */
        h1 {
            font-size: 28px;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        /* Controls */
        .controls {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        select, button, input {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            outline: none;
        }

        /* Buttons */
        button {
            background: #4CAF50;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s ease;
            border: none;
        }

        button:hover {
            background: #45a049;
        }

        /* SVG Area */
        svg {
            width: 90vw;
            height: 80vh;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        /* Nodes */
        .node {
            fill: #90CAF9; /* Soft Blue */
            stroke: #2c3e50;
            stroke-width: 2px;
        }

        .node:hover {
            fill: #64B5F6;
        }

        /* Transport Links */
        .link {
            stroke: #bbb;
            stroke-width: 2px;
        }

        /* Transporter */
        .transporter {
            fill: #E57373; /* Soft Red */
            stroke: black;
            stroke-width: 2px;
        }

        /* Log Panel */
        #logPanel {
            width: 90vw;
            height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            background: #ffffff;
            box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
        }

        #logList {
            list-style-type: none;
            padding: 0;
        }

        /* Request Form */
        .request-form {
            margin-top: 20px;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
        }

        .request-form h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="logPanel">
        <h3>üöë Transport Log</h3>
        <ul id="logList"></ul>
    </div>

    <h1>Hospital Transport System</h1>

    <div class="controls">
    <label for="transporterSelect">Choose a Transporter:</label>
    <select id="transporterSelect"></select>

    <!-- üöÄ New Status Dropdown & Button -->
    <label for="statusDropdown">Set Transporter Status:</label>
    <select id="statusDropdown">
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
    </select>
    <button onclick="setTransporterStatus()">Update Status</button>
    <!-- üöÄ End New Status Dropdown -->

    <label for="requestSelect">Choose a Transport Request:</label>
    <select id="requestSelect"></select>

    <input type="text" id="transporterName" placeholder="Transporter Name">
    <button onclick="addTransporter()">Add Transporter</button>

    <button onclick="initiateTransport()">Initiate Patient Transport</button>
    <button id="returnHomeBtn" onclick="returnHome()">Return Home</button>
    <button onclick="deployOptimization()">Deploy Optimization</button>
</div>


    <div class="request-form">
        <h3>Create New Transport Request</h3>

        <label for="originDropdown">Origin:</label>
        <select id="originDropdown"></select>

        <label for="destinationDropdown">Destination:</label>
        <select id="destinationDropdown"></select>

        <label for="typeDropdown">Transport Type:</label>
        <select id="typeDropdown">
            <option value="stretcher">Stretcher</option>
            <option value="wheelchair">Wheelchair</option>
        </select>

        <label for="urgentDropdown">Urgency:</label>
        <select id="urgentDropdown">
            <option value="true">Urgent</option>
            <option value="false">Not Urgent</option>
        </select>

        <button onclick="createRequest()">Create Request</button>
    </div>

    <svg viewBox="-100 -100 1400 1000"></svg>

    <script>
        var svg = d3.select("svg"), width = 1400, height = 1000;
        var transporters = {}, transportRequests = {}, transporterNodes = {};
        var socket = io("http://127.0.0.1:5001");

        function loadHospitalGraph() {
    fetch("http://127.0.0.1:5001/get_hospital_graph")
        .then(response => response.json())
        .then(graph => {
            let nodesMap = new Map(graph.nodes.map(n => [n.id, { id: n.id, x: n.x, y: n.y }]));

            let edges = graph.edges.map(e => ({
                source: nodesMap.get(e.source),
                target: nodesMap.get(e.target),
                weight: e.distance  // üîπ Store weight for display
            }));

            // Draw edges (lines)
            svg.append("g").selectAll("line").data(edges).enter().append("line")
                .attr("class", "link")
                .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x).attr("y2", d => d.target.y);

            // Draw edge weights (text)
            svg.append("g").selectAll("text.edge-label").data(edges).enter().append("text")
                .attr("class", "edge-label")
                .attr("x", d => (d.source.x + d.target.x) / 2)  // üîπ Middle of the edge
                .attr("y", d => (d.source.y + d.target.y) / 2 - 5)  // üîπ Slightly above
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .attr("font-size", "12px")
                .attr("font-weight", "bold")
                .text(d => d.weight);  // üîπ Display weight

            // Draw nodes (circles)
            svg.append("g").selectAll("circle").data([...nodesMap.values()]).enter().append("circle")
                .attr("class", "node").attr("r", 20)
                .attr("cx", d => d.x).attr("cy", d => d.y)
                .attr("data-node", d => d.id);

            // Draw node labels (text)
            svg.append("g").selectAll("text").data([...nodesMap.values()]).enter().append("text")
                .attr("x", d => d.x + 10).attr("y", d => d.y - 10).text(d => d.id);
        });
}
        function deployOptimization() {
    console.log("üöÄ Deploying Optimization...");

    fetch("http://127.0.0.1:5001/deploy_optimization", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("‚ùå Optimization Failed: " + data.error);
        } else {
            alert("‚úÖ Optimization Deployed! Transporters are moving.");
            loadTransportRequests(); // Refresh dropdowns
        }
    })
    .catch(error => console.error("‚ùå Error:", error));
}
        function addTransporter() {
    let transporterName = document.getElementById("transporterName").value.trim();

    if (!transporterName) {
        alert("‚ùå Please enter a transporter name.");
        return;
    }

    fetch("http://127.0.0.1:5001/add_transporter", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: transporterName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("‚ùå Error: " + data.error);
        } else {
            alert("‚úÖ Transporter added successfully!");
            document.getElementById("transporterName").value = ""; // Rensa f√§ltet
            loadTransporters(); // Uppdatera dropdown-listan
        }
    })
    .catch(error => console.error("‚ùå Error:", error));
}

        function returnHome() {
    const selectedTransporter = document.getElementById("transporterSelect").value;

    if (!selectedTransporter) {
        alert("Please select a transporter first.");
        return;
    }

    fetch("/return_home", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ transporter: selectedTransporter })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            alert(data.status);
        }
    })
    .catch(error => console.error("Error:", error));
}

function setTransporterStatus() {
    let transporterName = document.getElementById("transporterSelect").value;
    let status = document.getElementById("statusDropdown").value;

    if (!transporterName) {
        alert("‚ùå Please select a transporter.");
        return;
    }

    fetch("http://127.0.0.1:5001/set_transporter_status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transporter: transporterName, status })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.status);
        loadTransporters();  // Refresh transporter list
    })
    .catch(error => console.error("‚ùå Error:", error));
}

function createTransporterVisual(name, location, color = "red") {
    let nodeElement = document.querySelector(`[data-node='${location}']`);
    if (!nodeElement) {
        console.error(`‚ùå Error: Node '${location}' not found for transporter '${name}'.`);
        return;
    }

    let x = parseFloat(nodeElement.getAttribute("cx"));
    let y = parseFloat(nodeElement.getAttribute("cy"));

    console.log(`üöõ Creating transporter ${name} at (${x}, ${y})`);

    transporterNodes[name] = svg.append("circle")
        .attr("class", "transporter")
        .attr("r", 10)
        .attr("cx", x)
        .attr("cy", y)
        .attr("fill", color)
        .attr("data-transporter", name);
}

       function loadTransporters() {
    fetch("http://127.0.0.1:5001/get_transporters")
        .then(response => response.json())
        .then(data => {
            let select = document.getElementById("transporterSelect");
            select.innerHTML = "";

            data.forEach(trans => {
                // Only add active transporters to dropdown
                if (trans.status === "active") {
                    let option = document.createElement("option");
                    option.value = trans.name;
                    option.textContent = trans.name;
                    select.appendChild(option);
                }

                // Update transporter status visually
                let color = trans.status === "active" ? "red" : "gray"; // Inactive transporters appear gray
                createTransporterVisual(trans.name, trans.current_location, color);
            });
        });
}

        function loadDepartmentDropdowns() {
    fetch("http://127.0.0.1:5001/get_hospital_graph")
        .then(response => response.json())
        .then(graph => {
            console.log("üè• Loaded hospital graph:", graph); // üîπ Debugging

            let originDropdown = document.getElementById("originDropdown");
            let destinationDropdown = document.getElementById("destinationDropdown");

            originDropdown.innerHTML = "";
            destinationDropdown.innerHTML = "";

            if (!graph.nodes || graph.nodes.length === 0) {
                console.error("‚ùå No nodes found in hospital graph!");
                return;
            }

            graph.nodes.forEach(node => {
                let option1 = document.createElement("option");
                option1.value = node.id;
                option1.textContent = node.id;
                originDropdown.appendChild(option1);

                let option2 = document.createElement("option");
                option2.value = node.id;
                option2.textContent = node.id;
                destinationDropdown.appendChild(option2);
            });

            console.log("‚úÖ Dropdowns populated successfully!");
        })
        .catch(error => console.error("‚ùå Error fetching departments:", error));
}


        function createRequest() {
    let origin = document.getElementById("originDropdown").value;
    let destination = document.getElementById("destinationDropdown").value;
    let transportType = document.getElementById("typeDropdown").value;
    let urgent = document.getElementById("urgentDropdown").value === "true";

    if (!origin || !destination || origin === destination) {
        alert("Please select a valid origin and destination.");
        return;
    }

    fetch("http://127.0.0.1:5001/frontend_transport_request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ origin, destination, transport_type: transportType, urgent })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.status || "Request created successfully!");
        loadTransportRequests();  // üîπ Refresh the request list
    })
    .catch(error => console.error("‚ùå Error:", error));
}


function removeRequest(requestKey) {
    fetch("http://127.0.0.1:5001/remove_transport_request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ requestKey })
    })
    .then(response => response.json())
    .then(data => {
        console.log("‚úÖ Request removed:", data);
        loadTransportRequests();  // üîπ Refresh dropdown after removal
    })
    .catch(error => console.error("‚ùå Error:", error));
}

socket.on("transport_completed", function (data) {
    console.log("üöÄ Transport completed:", data);

    let logList = document.getElementById("logList");
    let logEntry = document.createElement("li");
    logEntry.textContent = `üèÅ ${data.transporter} has completed their transport.`;

    logList.appendChild(logEntry);
    logList.scrollTop = logList.scrollHeight; // üîÑ Auto-scroll to latest log

    loadTransportRequests(); // üîÑ Refresh available requests
});
socket.on("transporter_status_update", function (data) {
    console.log("üîÑ Transporter status update:", data);
    loadTransporters(); // Refresh transporter list
});


socket.on("new_transporter", function (data) {
    console.log("üöë New transporter added:", data);
    loadTransporters(); // Laddar om dropdown-listan
});
socket.on("transporter_update", function (data) {
    console.log("üöÄ Transporter update received:", data);
    updateTransporterVisual(data.name, data.location);
});
socket.on("transport_assigned", function (data) {
    console.log("üìù Transport assigned:", data);

    let logList = document.getElementById("logList");
    let logEntry = document.createElement("li");
    logEntry.textContent = `‚úÖ ${data.transporter} assigned to transport ${data.transport_type} from ${data.origin} to ${data.destination}. Urgent: ${data.urgent ? "Yes" : "No"}`;

    logList.appendChild(logEntry);
    logList.scrollTop = logList.scrollHeight; // üîÑ Auto-scroll to latest log
});



        function loadTransportRequests() {
    fetch("http://127.0.0.1:5001/get_transport_requests")
        .then(response => response.json())
        .then(data => {
            let select = document.getElementById("requestSelect");
            select.innerHTML = ""; // Clear dropdown

            if (!data.pending || data.pending.length === 0) {
                console.warn("‚ö†Ô∏è No pending requests available.");
                return;
            }

            data.pending.forEach(req => {
                let option = document.createElement("option");
                option.value = `${req.origin}-${req.destination}`;
                option.textContent = `${req.transport_type} from ${req.origin} to ${req.destination}`;
                select.appendChild(option);
                transportRequests[option.value] = req; // Store in global object
            });

            console.log("‚úÖ Transport requests loaded successfully.");
        })
        .catch(error => console.error("‚ùå Error loading transport requests:", error));
}




        function createTransporterVisual(name, location) {
            let nodeElement = document.querySelector(`[data-node='${location}']`);

            if (!nodeElement) {
                console.error(`‚ùå Error: Node '${location}' not found for transporter '${name}'.`);
                return;
            }

            let x = parseFloat(nodeElement.getAttribute("cx"));
            let y = parseFloat(nodeElement.getAttribute("cy"));

            console.log(`üöõ Creating transporter ${name} at (${x}, ${y})`);

            transporterNodes[name] = svg.append("circle")
                .attr("class", "transporter")
                .attr("r", 10)
                .attr("cx", x)
                .attr("cy", y)
                .attr("fill", "red")
                .attr("data-transporter", name);
        }

        function updateTransporterVisual(name, newLocation) {
            let nodeElement = document.querySelector(`[data-node='${newLocation}']`);
            let transporterElement = d3.select(`[data-transporter='${name}']`);

            if (!nodeElement || transporterElement.empty()) {
                console.error(`‚ùå Error: Node '${newLocation}' or transporter '${name}' not found for movement.`);
                return;
            }

            let x = parseFloat(nodeElement.getAttribute("cx"));
            let y = parseFloat(nodeElement.getAttribute("cy"));

            console.log(`üìç Moving transporter ${name} to ${newLocation} at (${x}, ${y})`);

            transporterElement
                .transition()
                .duration(1000)
                .attr("cx", x)
                .attr("cy", y)
                .on("end", () => console.log(`‚úÖ ${name} arrived at (${x}, ${y})`));
        }

        socket.on("transporter_update", function (data) {
            console.log("üöÄ Transporter update received:", data);
            let transporterName = data.name;
            let newLocation = data.location;

            if (!transporterNodes[transporterName]) {
                console.error("‚ö†Ô∏è Transporter element not found in visualization for", transporterName);
                return;
            }

            updateTransporterVisual(transporterName, newLocation);
        });

        function initiateTransport() {
    let transporterName = document.getElementById("transporterSelect").value;
    let requestValue = document.getElementById("requestSelect").value;
    let requestObj = transportRequests[requestValue]; // ‚¨ÖÔ∏è Ensure we get it from pending requests

    if (!transporterName || !requestObj) {
        console.error("‚ö†Ô∏è Missing transporter or transport request selection.");
        alert("Please select both a transporter and a request.");
        return;
    }

    console.log(`üõ´ Assigning ${transporterName} to transport from ${requestObj.origin} to ${requestObj.destination}`);

    fetch("http://127.0.0.1:5001/assign_transport", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            transporter: transporterName,
            origin: requestObj.origin,
            destination: requestObj.destination,
            transport_type: requestObj.transport_type,
            urgent: requestObj.urgent
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log("‚úÖ Response:", data);
        if (data.error) {
            alert("‚ùå Error: " + data.error);
        } else {
            alert(data.status || "Transport initiated!");
            loadTransportRequests(); // üîÑ Refresh available transport requests
        }
    })
    .catch(error => console.error("‚ùå Error:", error));
}



        window.onload = function () {
            loadHospitalGraph();
            loadTransporters();
            loadTransportRequests();
            loadDepartmentDropdowns();
        };
    </script>
</body>
</html>
